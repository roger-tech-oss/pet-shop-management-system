<script src="https://www.paypalobjects.com/api/checkout.js"></script>
<?php
$total = 0;
$stockAvailable = true; // Initialize stock check flag
$outOfStockMessage = ""; // Initialize out of stock message

$qry = $conn->query("SELECT c.*, p.product_name, i.size, i.price, i.quantity AS stock_quantity, p.id as pid 
                     FROM `cart` c 
                     INNER JOIN `inventory` i ON i.id = c.inventory_id 
                     INNER JOIN products p ON p.id = i.product_id 
                     WHERE c.client_id = " . $_settings->userdata('id'));

// Check stock for each item in cart
while ($row = $qry->fetch_assoc()):
    // Check if the cart quantity exceeds available stock
    if ($row['quantity'] > $row['stock_quantity']) {
        $stockAvailable = false;
        $outOfStockMessage .= $row['product_name'] . " is out of stock.<br>";
    }
    $total += $row['price'] * $row['quantity'];
endwhile;

// Calculate delivery charge
$delivery_charge = $conn->query("SELECT * FROM delivery_charge WHERE pincode = '" . $_settings->userdata('pincode') . "' ")->fetch_array();
if (!isset($delivery_charge['delivery_charge']))
    $delivery_charge = 50;
else
    $delivery_charge = (int) $delivery_charge['delivery_charge'];

// If any item is out of stock, display message and prevent checkout
if (!$stockAvailable): ?>
    <div class="alert alert-danger text-center">
        <h5>Some items are not available:</h5>
        <?php echo $outOfStockMessage; ?>
    </div>
<?php
else:
    ?>
<section class="py-5">
    <div class="container">
        <div class="card rounded-0">
            <div class="card-body"></div>
            <h3 class="text-center"><b>Checkout</b></h3>
            <hr class="border-dark">
            <form action="" id="place_order">
                <input type="hidden" name="amount" value="<?php echo $total ?>">
                <input type="hidden" name="payment_method" value="cod">
                <input type="hidden" name="paid" value="0">
                <div class="row row-col-1 justify-content-center">
                    <div class="col-6">
                        <div class="form-group col">
                            <label for="" class="control-label">Delivery Address</label>
                            <textarea id="" cols="30" rows="3" name="delivery_address" class="form-control" style="resize:none"><?php echo $_settings->userdata('default_delivery_address') ?></textarea>
                        </div>
                        <div class="col">
                            <span><h4><b>Total:</b> <?php echo number_format($total + $delivery_charge) ?></h4></span>
                        </div>
                        <hr>
                        <div class="col my-3">
                        <h4 class="text-muted">Payment Method</h4>
                            <div class="d-flex w-100 justify-content-between">
                                <button class="btn btn-flat btn-dark">Cash on Delivery</button>
                                <span id="paypal-button"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</section>
<script>
paypal.Button.render({
    env: 'sandbox', // change for production if app is live,
 
        //app's client id's
	client: {
        sandbox:    'AdDNu0ZwC3bqzdjiiQlmQ4BRJsOarwyMVD_L4YQPrQm4ASuBg4bV5ZoH-uveg8K_l9JLCmipuiKt4fxn',
        //production: 'AaBHKJFEej4V6yaArjzSx9cuf-UYesQYKqynQVCdBlKuZKawDDzFyuQdidPOBSGEhWaNQnnvfzuFB9SM'
    },
 
    commit: true, // Show a 'Pay Now' button
 
    style: {
    	color: 'blue',
    	size: 'small'
    },
 
    payment: function(data, actions) {
        return actions.payment.create({
            payment: {
                transactions: [
                    {
                    	//total purchase
                        amount: { 
                        	total: '<?php echo $total; ?>', 
                        	currency: 'PHP' 
                        }
                    }
                ]
            }
        });
    },
 
    onAuthorize: function(data, actions) {
        return actions.payment.execute().then(function(payment) {
    		// //sweetalert for successful transaction
    		// swal('Thank you!', 'Paypal purchase successful.', 'success');
            payment_online()
        });
    },
 
}, '#paypal-button');

function payment_online(){
    $('[name="payment_method"]').val("Online Payment")
    $('[name="paid"]').val(1)
    $('#place_order').submit()
}
$(function(){
    $('#place_order').submit(function(e){
        e.preventDefault()
        start_loader();
        $.ajax({
            url:'classes/Master.php?f=place_order',
            method:'POST',
            data:$(this).serialize(),
            dataType:"json",
            error:err=>{
                console.log(err)
                alert_toast("an error occured","error")
                end_loader();
            },
            success:function(resp){
                if(!!resp.status && resp.status == 'success'){
                    alert_toast("Order Successfully placed.","success")
                    setTimeout(function(){
                        location.replace('./')
                    },2000)
                }else{
                    console.log(resp)
                    alert_toast("an error occured","error")
                    end_loader();
                }
            }
        })
    })
})
</script>
<?php endif; ?>
